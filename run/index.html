<!DOCTYPE html>
<html>
    <head>
        <title>Maze sentence repetition task</title>
        <script src="https://unpkg.com/jspsych@7.2.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
        <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.1"></script>
        <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.1"></script>
        <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
        <link rel="stylesheet" href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css">
        <style>
        .jspsych-display-element {
            font-family: 'Open Sans', 'Arial', sans-serif;
            font-size: 32px;
            line-height: 1.6em;
        }
        p#istr {
            color: red;
            font-size: 18px;
        }
        p#istrR {
            color: red;
            font-size: 18px;
        }
        p#istrG {
            color: green;
            font-size: 18px;
        }
        </style>
    </head>
    <body></body>
<script>

async function createExperiment(){


  //  funzioni per creare i maze trials

  function make_sp_trial(itemID, cond, sentence) {
    var sentence_as_word_list = sentence.split(" ") //split the sentence at spaces
    var stimulus_sequence = [] //empty stimulus sequence to start
    stimulus_sequence.push({
      'stimulus': '+',
      'data' : {'item':itemID,'cond':cond,'type': 'selfpaced','wp':-1, 'words': 'fix', 'corrkey': ' '} 
    })
    for (let wp=0; wp<sentence_as_word_list.length; wp++) {
      var word = sentence_as_word_list[wp];
      var responses = [' ']; 
      stimulus_sequence.push({
        'stimulus': word,
        'data' : {'item':itemID,'cond':cond,'type': 'selfpaced','wp':wp, 'words': word, 'corrkey': ' '} 
      }) //add that word in the required format
    }
    return stimulus_sequence
  };

  function make_maze_trial(itemID, cond, sentence1,sentence2) {
    var sentence1_as_word_list = sentence1.split(" ") //split the sentence at spaces
    var sentence2_as_word_list = sentence2.split(" ") //split the sentence at spaces
    var stimulus_sequence = [] //empty stimulus sequence to start
    for (let wp=0; wp<sentence1_as_word_list.length; wp++) {
      var pair = [sentence1_as_word_list[wp], sentence2_as_word_list[wp]];
      var correct = 0;
      var responses = ['F', 'J'];
      if (Math.random()<0.5) {
        pair = [sentence2_as_word_list[wp], sentence1_as_word_list[wp]];
        correct =1;
      } 
      stimulus_sequence.push({'stimulus':`
        <table border="0" width="500">
        <tr>
            <td style="text-align: center; width: 40%; vertical-align: middle;"> `+ pair[0]+`</td>
            <td style="text-align: center; width: 10%; vertical-align: middle;"> + </td>
            <td style="text-align: center; width: 40%; vertical-align: middle;">`+ pair[1]+`</td>
        </tr>
        </table>
      `, 'data' : {'item':itemID,'type':'maze', 'cond':cond,'wp':wp, 'words': pair, 'corrkey': responses[correct]} }) //add that word in the required format
  }
  return stimulus_sequence
 };


function make_maze_block(itemID,cond,sentence1,sentence2,nrep) {
  var interrep= {
    type: jsPsychHtmlKeyboardResponse,
    choices: [' '],
    stimulus: function(){
      if(anyerror>0){
        n = anyerror;
        anyerror =0;
        if (n>1) {
          return " <p id='istrR'> Hai fatto " + n + " errori, fai maggiore attenzione. Quando sei prontə a riprovare premi spazio.</p>"; 
        } else {
          return " <p id='istrR'> Hai fatto un errore, fai maggiore attenzione. Quando sei prontəa riprovare premi spazio.</p>"; // the parameter value has to be returned from the function
        } 
      } else {
        return " <p id='istrG''>Quando sei prontə a ripetere ancora la stessa frase premi spazio.</p>"; // the parameter value has to be returned from the function
        anyerror = 0;
      }
    }
  };

  var endsent= {
        type: jsPsychHtmlKeyboardResponse,
        choices: [' '],
        stimulus: " <p id='istr'>Con questa frase abbiamo finito, quando sei prontə per la prossima premi spazio.</p>"
  }
  
  var startrep= {
        type: jsPsychHtmlKeyboardResponse,
        choices: [' '],
        stimulus: " <p id='istr'>Posiziona le dita sui tasti F e J e quando sei prontə per ripetere premi spazio.</p>"
  }

  var timel =[];
  var anyerror = 0;
  var sp = {
      type: jsPsychHtmlKeyboardResponse,
      choices: [' '],
      timeline: make_sp_trial(itemID, cond, sentence1),
      on_finish: function(data) {
        data.correct=true;
      }
  };
  timel.push(sp);
  timel.push(startrep);
  for (let i=0; i<nrep; i++){
    var mazesent = {
      type: jsPsychHtmlKeyboardResponse,
      choices: ['F','J'],
      timeline: make_maze_trial(itemID, cond, sentence1, sentence2),
      on_finish: function(data) {
        data.correct=true;
      if (!jsPsych.pluginAPI.compareKeys(data.response, data.corrkey)) {
        data.correct=false;
        anyerror = anyerror + 1;
        // uncomment this to end repetition on errors
        // jsPsych.endCurrentTimeline();
      }
      },
    };
    timel.push(mazesent);
    if(i<(nrep-1)) {
      timel.push(interrep);
    } else {
      timel.push(endsent);
    }
  }
  return timel;
  }

  // start jsPsych

  var jsPsych = initJsPsych({
    use_webaudio: false,
    on_finish: function(){
      //jsPsych.data.displayData();
    }
  });

  // load material from github
  
  let response = await fetch('https://raw.githubusercontent.com/francesco-vespignani/RepetitionMaze/main/material/material.json');
  let alllists = await response.json();
  

  // set default parameters and query from url params

  var distr = 'nw';
  var list = 'listA';
  var rep = 5;
  var casual = true;
  var id = null; 

  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  if (urlParams.has('list')) {
    list = urlParams.get('list');
  }
  if (urlParams.has('distr')) {
    distr = urlParams.get('distr');
  }
  if (urlParams.has('rep')) {
    rep = urlParams.get('rep');
  }
  if (urlParams.has('casual')) {
    casual = urlParams.get('casual');
  }
  if (urlParams.has('id')) {
    id = urlParams.get('id');
  }  

  //  select list and condition

  stim = alllists[distr][list]['exp'];
  var n = stim.length;
  //  MAKE IT SHORTER FOR TEST 
  var n = 2;

  var indexes = Array.from(Array(stim.length).keys());
  if (casual) {
    indexes = jsPsych.randomization.repeat(indexes, 1);
  }
  
  //  timeline for instructions and practice
  
  var instructions = {
    type: jsPsychInstructions,
    button_label_previous: "Indietro",
    button_label_next: "Avanti",
    pages: [
    'Ciao, grazie per partecipare a questa ricerca!' +
    '<br>' + 
    'Questa prova durerà XX minuti.' +
    '<br>' + 
    'Ti chiediamo di trovare un posto tranquillo e una posizione comoda per svolgere la prova' +
    ' senza distrazioni nel modo più accurato e veloce possibile',
    'Ogni prova consiste di due fasi' +
    '<br>' + 
    'FASE 1: vedrai delle frasi che dovrai leggere, saranno presentate una parola alla volta,'+
    ' per procedere dovrai premere la <b>BARRA SPAZIATRICE</b>' +
    '<br>' + 
    'FASE 2: vedrai una sequenza di coppie di parole, una sulla destra e una sulla sinistra' +
    ' e dovrai scegliere le parole che formano la frase appena letta,' +
    ' premendo i tasti  <b>J</b> (destra) o <b>F</b> (sinistra)',
    'Fase 1: lettura' +
    '<br>' + 
    '<p align="center"><iframe src="selfpaced.html" width="670" height="600" style="border:none;""></iframe></p>',
    'Fase 2: ripetizione' +
    '<br>' + 
    '<p align="center"><iframe src="maze_'+distr+'.html" width="670" height="600" style="border:none;""></iframe></p>',
    'La Fase 2 sarà ripetuta più volte per ogni singola frase.' +
    '<br>' + 
    'Alcune frasi contengono errori ma vanno ripetute così come viste.' +
    '<br>' + 
    'Prima di iniziare con l\'esperimento ci sarà una breve pratica. ' +
    '<br>' +
    'Non chiudere il browser o ricaricare la pagina web fino a quando l\'esperimento non è finito' +
    ' altrimenti i tuoi dati saranno persi',
    ],
    show_clickable_nav: true
  }

  var startnow = {
    type: jsPsychHtmlKeyboardResponse,
    choices: [' '],
    stimulus: ` 
    <p id='istr'>Ora inizia l'esperimento vero e proprio, premi spazio per iniziare, buon lavoro! </p>   `
  };

  var enter_fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  }

  var exit_fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: false,
    delay_after: 0
  }
  //  create filename and save data element

  var subject_id = null;
  if (id==null) {
    subject_id = jsPsych.randomization.randomID(10);
  } else  {
    subject_id = 'url_'+id;
  }

  const filename = `${subject_id}.csv`;
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "uF6LUPwFJwxW",
    filename: filename,
    data_string: ()=>jsPsych.data.get().addToAll({id:id, distr: distr, list: list, casual:casual, rep:rep}).csv()
  };

  const datasaved = {
    type: jsPsychHtmlKeyboardResponse,
    choices: [' '],
    stimulus: ` 
    <p id='istr'> I dati sono stati svalvati, ora puoi chiudere la finestra del browser. Grazie! </p>   `
  };


  // create and fill main experiment timeline

  var timeline= [];

  timeline.push(enter_fullscreen);
  timeline.push(instructions);
  timeline.push(startnow);
  
  for (let si=0; si<n; si++) {
    var tmp = stim[indexes[si]];
    var h = make_maze_block (tmp.item, tmp.cond, tmp.s1, tmp.s2, rep);
    timeline = timeline.concat(h);
  }
 
  timeline.push(save_data);
  timeline.push(exit_fullscreen);
  timeline.push(datasaved);

  //  run it

  jsPsych.run(timeline);
}

createExperiment();

</script>
</html>